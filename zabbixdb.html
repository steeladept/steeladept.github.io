<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content="getting_startedzabbixzabbix database,  zabbix database centos">
<title>Installing MySQL 8.0 on CENTOS 7 for Zabbix | Steeladeptâ€™s Github Pages</title>
<link rel="stylesheet" href="css/syntax.css">

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/boxshadowproperties.css">
<!-- most color styles are extracted out to here -->
<link rel="stylesheet" href="css/theme-green-dark.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="documentation-theme-jekyll" href="http://localhost:4000/feed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-static-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> Rambling Thoughts of Steeladept</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li>
                <!-- entries without drop-downs appear here -->




                
                
                
                <li><a href="news">Latest Posts</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Projects<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="git">Git & GitHub</a></li>
                        
                        
                        
                        <li><a href="jekyll">Jekyll</a></li>
                        
                        
                        
                        <li><a href="linux">Linux</a></li>
                        
                        
                        
                        <li><a href="markdown">Markdown</a></li>
                        
                        
                        
                        <li><a href="powershell">Powershell</a></li>
                        
                        
                        
                        <li><a href="vmware">VMware</a></li>
                        
                        
                        
                        <li class="dropdownActive"><a href="zabbix">Zabbix</a></li>
                        
                        
                    </ul>
                </li>
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Living Life<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="">About</a></li>
                        
                        
                    </ul>
                </li>
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Jekyll Help<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="https://github.com/tomjoht/documentation-theme-jekyll" target="_blank">Jekyll Doc Theme Download (this theme)</a></li>
                        
                        
                        
                        <li><a href="jekylldocs.html">Getting started with Jekyll Doc Theme</a></li>
                        
                        
                        
                        <li><a href="https://talk.jekyllrb.com" target="_blank">Jekyll Talk</a></li>
                        
                        
                        
                        <li><a href="http://jekyllrb.com/docs/home/" target="_blank">Jekyll documentation</a></li>
                        
                        
                        
                        <li><a href="http://stackoverflow.com/questions/tagged/jekyll" target="_blank">Jekyll on Stack Overflow</a></li>
                        
                        
                        
                        <li><a href="http://idratherbewriting.com/category-jekyll/" target="_blank">Jekyll on my blog</a></li>
                        
                        
                    </ul>
                </li>
                
                
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Installing MySQL 8.0 on CENTOS 7 for Zabbix">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                <p><img src="images/site_logo.png" alt="Site logo"/></p>


<ul id="mysidebar" class="nav">
  <li class="sidebarTitle">Zabbix 4.0</li>
  
  
  
      
  
  <li>
      <a href="#">Overview</a>
      <ul>
          
          
          
          <li><a href="zabbix.html">Get started</a></li>
          
          
          
          
          
          
          <li class="active"><a href="zabbixdb.html">Installing MySQL Database</a></li>
          
          
          
          
          
          
          <li><a href="zabbixserver.html">Installing Zabbix Application Server</a></li>
          
          
          
          
          
          
          <li><a href="zabbixweb.html">Installing Apache Web Server for Zabbix</a></li>
          
          
          
          
          
          
          <li><a href="zabbixproxy.html">Installing Zabbix Proxy Server</a></li>
          
          
          
          
          
          
          <li><a href="zabbixagent.html">Installing Zabbix Agent</a></li>
          
          
          
          
      </ul>
   </li>
     
      
      
      <!-- if you aren't using the accordion, uncomment this block:
         <p class="external">
             <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
         </p>
         -->
</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            <div class="post-header">
   <h1 class="post-title-main">Installing MySQL 8.0 on CENTOS 7 for Zabbix</h1>
   <p class="post-meta">Oct 29, 2018</p>
</div>



<div class="post-content">

   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    


    

   <h2 id="installing-centos-7">Installing CENTOS 7</h2>

<blockquote>
  <p>The assumption is you already have CENTOS 7 installed, connected to the internet and network location(s), and updated to current patch level.</p>
</blockquote>

<p>This document will take the user from an initial CENTOS 7 setup to a full Zabbix installation.  All steps should be included and anything missing should be added or relayed to the author for addition.</p>

<h2 id="add-additional-resources-if-necessary">Add additional resources (if necessary)</h2>

<h3 id="cpumemory">CPU/MEMORY</h3>

<ul>
  <li>These should be added in the VMware Console before starting the machine, if possible.  Hot-add is possible, but could lead to stability issues and force a reboot.</li>
</ul>

<p><strong>Zabbix Server</strong>:</p>
<blockquote>
  <p>Configure to a minimum of 2 CPU and 24GB RAM</p>
</blockquote>

<p><strong>Zabbix Proxy</strong>:</p>
<blockquote>
  <p>Configure to a minimum of 1 CPU and 8GB RAM</p>
</blockquote>

<h3 id="hard-drive-space-zabbix-server-database-only">Hard Drive Space (Zabbix Server Database only)</h3>

<ul>
  <li>
    <p>Add 2nd Hard Drive to VM in VMware</p>
  </li>
  <li>
    <p>Add Hard Drive in Linux</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># First, determine device name (most likely sdb)</span>
<span class="nb">ls</span> <span class="nt">-1</span> /dev/sd<span class="k">*</span>

<span class="c"># Once you find it, issue the following commands changing the name of the hard drive as necessary</span>
mkfs.xfs /dev/sdb
</code></pre></div></div>

<blockquote>
  <p>We will mount this at the data store mount point after installing mysql and before starting it up</p>
</blockquote>

<h2 id="installing-zabbix-prerequisites">Installing Zabbix Prerequisites</h2>

<ul>
  <li>Download the mysql repository</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$wget</span> https://dev.mysql.com/get/mysql80-community-release-el7-1.noarch.rpm
<span class="nv">$rpm</span> <span class="nt">-ivh</span> mysql80-community-release-el7-1.noarch.rpm
</code></pre></div></div>

<ul>
  <li>Install the database - <em>(MySQL is used here, but MariaDB or Postgres can be substituted - check Zabbix documentation for version requirements)</em></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$yum</span> <span class="nt">-y</span> install mysql-community-server
</code></pre></div></div>

<ul>
  <li>Mount the new hard drive to /var/lib/mysql and configuration in /etc/fstab to make it permanent</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$mount</span> /dev/sdb /var/lib/mysql
<span class="nv">$ </span>vim /etc/fstab

<span class="c">#add the following line to the bottom (assuming the device name (sdb) is valid)</span>
/dev/sdb                                  /var/lib/mysql                   xfs     defaults        0 0
</code></pre></div></div>

<ul>
  <li>Open the firewall port to allow connection to mysql</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$firewall</span><span class="nt">-cmd</span> <span class="nt">--permanent</span> <span class="nt">--add-port</span><span class="o">=</span>3306/tcp
<span class="nv">$firewall</span><span class="nt">-cmd</span> <span class="nt">--reload</span>
<span class="nv">$firewall</span><span class="nt">-cmd</span> <span class="nt">--list-all</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Setup MySQL Database</p>

    <p><em>NOTE: On CENTOS7, MySQL generates a temporary database root password written to the log in /var/log/mysqld.log after initial startup.  As shown in the steps below, get this password before running the mysql_secure_connection script or it will throw an error</em></p>

    <p><em>NOTE: I am using mysql root user password of MySQLrootpass*1 (in test only)</em></p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$systemctl</span> start mysqld
<span class="nv">$grep</span> <span class="s1">'temporary password'</span> /var/log/mysqld.log
<span class="nv">$mysql_secure_installation</span>
<span class="c">#Enter password from log file</span>
<span class="c">#Change password</span>
<span class="c">#Select 'no' when prompted to change password (you just did it, no need to do so again)</span>
<span class="c">#Select yes, to all the rest of the questions:</span>
    <span class="c">#Remove anonymous users</span>
    <span class="c">#Disallow remote ROOT access</span>
    <span class="c">#Remove test databases</span>
    <span class="c">#Reload privilege tables</span>
</code></pre></div></div>

<blockquote>
  <p>The base install of MySQL is now complete</p>
</blockquote>

<h2 id="installing-zabbix-database">Installing Zabbix Database</h2>

<ul>
  <li>Install the Zabbix Repository <em>(full command for the repo on the downloads page for the version to be installed)</em></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$rpm</span> <span class="nt">-ivh</span> https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-1.el7.noarch.rpm
</code></pre></div></div>

<ul>
  <li>Install Zabbix Database Packages</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$yum</span> <span class="nt">-y</span> install zabbix-server-mysql zabbix-agent
</code></pre></div></div>

<ul>
  <li>
    <p>Add Zabbix User to database</p>

    <p><em>NOTE: I am using a zabbix database password of Zabdbpass*1 (in test only)</em></p>
  </li>
</ul>

<p>Note that â€˜&lt;serverID&gt;â€™ is the host name of the server that will connect</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span><span class="n">mysql</span> <span class="o">-</span><span class="n">uroot</span> <span class="o">-</span><span class="n">p</span>
<span class="n">password</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">database</span> <span class="n">zabbix</span> <span class="n">character</span> <span class="k">set</span> <span class="n">utf8</span> <span class="k">collate</span> <span class="n">utf8_bin</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">user</span> <span class="s1">'zabbix'</span><span class="o">@</span><span class="s1">'&lt;serverID&gt;'</span> <span class="n">identified</span> <span class="k">with</span> <span class="n">mysql_native_password</span> <span class="k">by</span> <span class="s1">'&lt;NewZabbixPassword&gt;'</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">grant</span> <span class="k">all</span> <span class="k">privileges</span> <span class="k">on</span> <span class="n">zabbix</span><span class="p">.</span><span class="o">*</span> <span class="k">to</span> <span class="s1">'zabbix'</span><span class="o">@</span><span class="s1">'&lt;serverID&gt;'</span> <span class="k">with</span> <span class="k">grant</span> <span class="k">option</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">quit</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>Edit the MySQL Configuration file to change the way the passwords work (needed only for MySQL 8+ due to a change in how the password encryption is done)</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$vim</span> /etc/my.cnf

<span class="c"># add the following lines to the config file (Can't do earlier or we can't run the secure_install script):</span>
skip_name_resolve
<span class="nv">default_authentication_plugin</span><span class="o">=</span>mysql_native_password
<span class="nv">event_scheduler</span><span class="o">=</span>ON
</code></pre></div></div>

<ul>
  <li>Import Zabbix Schema</li>
</ul>

<blockquote>
  <p>NOTE: The database for Server and Proxy are slightly different - use the correct zcat command based on the machine role the database will be used for!  Also, if multiple databases will exist on same server, each must use a unique name.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#NOTE: Because you didn't read the note above - The database for Server and Proxy are slightly different - use the correct zcat command based on the machine role.  ALSO NOTE this does take a while in both cases.  Please be patient and wait for the command to finish!</span>

<span class="c">#Server Schema</span>
<span class="nv">$zcat</span> /usr/share/doc/zabbix-server-mysql<span class="k">*</span>/create.sql.gz | mysql <span class="nt">-uzabbix</span> <span class="nt">-p</span> zabbix

<span class="c">#Proxy Schema</span>
<span class="nv">$zcat</span> /usr/share/doc/zabbix-proxy-mysql<span class="k">*</span>/schema.sql.gz | mysql <span class="nt">-uzabbix</span> <span class="nt">-p</span> zabbix

<span class="nv">$systemctl</span> <span class="nb">enable </span>mysqld
</code></pre></div></div>

<p>Do not forget to install the agent.  See <a href="/zabbixagent.html">Agent Configuration Guide</a> for details.</p>

<blockquote>
  <p>Note that you may need to come back and add or adjust this after you install Application Server and front end Web Server so you can verify functionality</p>
</blockquote>

<h2 id="partitioning-the-database-server-database-only">Partitioning the Database (Server Database only)</h2>

<blockquote>
  <p>Skip down to NEXT STEPS if you do not need to partition your database</p>
</blockquote>

<p><em>Shout-out here to <a href="https://www.zabbix.com/forum/member/207631-ingus-vilnis">ingus.vilnis</a>, Senior Member on the Zabbix Forums who single-handedly provided all the information below based on the <a href="http://zabbix.org/wiki/Docs/howto/mysql_partitioning">YAMP wiki page</a></em></p>

<p>Anytime you expect to hit somewhere above 500 NVPS (New Values Per Second) you should consider using partitioning instead of the built in housekeeper functions.  In so doing, you sacrifice some historical granularity in favor of performance, so consider how important your historical data is before using this method of performance enhancements.  In particular, with the housekeeper running, you can individually control how long you keep data for each item.  With partitioning, however, you control how long you keep each item grouping (as defined by the table that is partitioned), instead of each individual item.</p>

<p>For my installations, I am using partitioning as there are no historical requirements defined for specific items and I am intending this installation to be capable of ~1500 NVPS or more.  There are a couple different approaches and several different methods available for partitioning.  I used the one highlighted and recommended in the <a href="http://zabbix.org/wiki/Docs/howto/mysql_partitioning">zabbix.org/wiki</a> which is to partition by range (date ranges to be exact) using a perl script.</p>

<ul>
  <li>Step one, verify there is no historical data that needs partitioned off</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="k">SELECT</span> <span class="n">FROM_UNIXTIME</span><span class="p">(</span><span class="k">MIN</span><span class="p">(</span><span class="n">clock</span><span class="p">))</span> <span class="k">FROM</span> <span class="nv">`history_uint`</span><span class="p">;</span>
<span class="o">#</span><span class="k">Result</span> <span class="n">should</span> <span class="n">be</span><span class="p">:</span>
<span class="o">#+</span><span class="c1">---------------------------+</span>
<span class="o">#|</span> <span class="n">FROM_UNIXTIME</span><span class="p">(</span><span class="k">MIN</span><span class="p">(</span><span class="n">clock</span><span class="p">))</span> <span class="o">|</span>
<span class="o">#+</span><span class="c1">---------------------------+</span>
<span class="o">#|</span> <span class="k">NULL</span>                      <span class="o">|</span>
<span class="o">#+</span><span class="c1">---------------------------+</span>
<span class="o">#</span><span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div></div>

<p>If it is not NULL, you can either truncate all tables or partition for each date between the history and today.  To alter each table, do the Alter step for each table incrementing dates from the UNIXTIME to today.  If you want to just truncate all data, do the following:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span><span class="k">TRUNCATE</span> <span class="k">TABLE</span> <span class="nv">`history`</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="k">TRUNCATE</span> <span class="k">TABLE</span> <span class="nv">`history_log`</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="k">TRUNCATE</span> <span class="k">TABLE</span> <span class="nv">`history_str`</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="k">TRUNCATE</span> <span class="k">TABLE</span> <span class="nv">`history_text`</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="k">TRUNCATE</span> <span class="k">TABLE</span> <span class="nv">`history_uint`</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="k">TRUNCATE</span> <span class="k">TABLE</span> <span class="nv">`trends_uint`</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="k">TRUNCATE</span> <span class="k">TABLE</span> <span class="nv">`trends`</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>Set the housekeeper table to use the BLACKHOLE database Engine</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">housekeeper</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">BLACKHOLE</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>Create a separate system user in the database for running the script against</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span><span class="k">create</span> <span class="k">user</span> <span class="s1">'zbx_part'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">identified</span> <span class="k">with</span> <span class="n">mysql_native_password</span> <span class="k">by</span> <span class="s1">'&lt;NewZabbixPassword&gt;'</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="k">GRANT</span> <span class="k">SELECT</span><span class="p">,</span> <span class="k">DELETE</span><span class="p">,</span> <span class="k">DROP</span><span class="p">,</span> <span class="k">ALTER</span> <span class="k">ON</span> <span class="n">zabbix</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'zbx_part'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="k">with</span> <span class="k">grant</span> <span class="k">option</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>Alter each table so it is ready for partitioning</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="nv">`history`</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">RANGE</span> <span class="p">(</span> <span class="n">clock</span><span class="p">)</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="n">p2018_10_24</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="n">UNIX_TIMESTAMP</span><span class="p">(</span><span class="nv">"2018-10-25 00:00:00"</span><span class="p">)</span> <span class="n">div</span> <span class="mi">1</span><span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">InnoDB</span><span class="p">);</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="nv">`history_log`</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">RANGE</span> <span class="p">(</span><span class="n">clock</span><span class="p">)</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="n">p2018_10_24</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="n">UNIX_TIMESTAMP</span><span class="p">(</span><span class="nv">"2018-10-25 00:00:00"</span><span class="p">)</span> <span class="n">div</span> <span class="mi">1</span><span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">InnoDB</span><span class="p">);</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="nv">`history_str`</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">RANGE</span> <span class="p">(</span><span class="n">clock</span><span class="p">)</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="n">p2018_10_24</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="n">UNIX_TIMESTAMP</span><span class="p">(</span><span class="nv">"2018-10-25 00:00:00"</span><span class="p">)</span> <span class="n">div</span> <span class="mi">1</span><span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">InnoDB</span><span class="p">);</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="nv">`history_text`</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">RANGE</span> <span class="p">(</span><span class="n">clock</span><span class="p">)</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="n">p2018_10_24</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="n">UNIX_TIMESTAMP</span><span class="p">(</span><span class="nv">"2018-10-25 00:00:00"</span><span class="p">)</span> <span class="n">div</span> <span class="mi">1</span><span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">InnoDB</span><span class="p">);</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="nv">`history_uint`</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">RANGE</span> <span class="p">(</span><span class="n">clock</span><span class="p">)</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="n">p2018_10_24</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="n">UNIX_TIMESTAMP</span><span class="p">(</span><span class="nv">"2018-10-25 00:00:00"</span><span class="p">)</span> <span class="n">div</span> <span class="mi">1</span><span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">InnoDB</span><span class="p">);</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="nv">`trends_uint`</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">RANGE</span> <span class="p">(</span> <span class="n">clock</span><span class="p">)</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="n">p2018_10</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="n">UNIX_TIMESTAMP</span><span class="p">(</span><span class="nv">"2018-11-01 00:00:00"</span><span class="p">)</span> <span class="n">div</span> <span class="mi">1</span><span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">InnoDB</span><span class="p">);</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="nv">`trends`</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">RANGE</span> <span class="p">(</span> <span class="n">clock</span><span class="p">)</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="n">p2018_10</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="n">UNIX_TIMESTAMP</span><span class="p">(</span><span class="nv">"2018-11-01 00:00:00"</span><span class="p">)</span> <span class="n">div</span> <span class="mi">1</span><span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">InnoDB</span><span class="p">);</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="n">quit</span>
</code></pre></div></div>

<ul>
  <li>Install the Perl prerequisites</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$yum</span> <span class="nt">-y</span> install perl-CPAN perl-DateTime-TimeZone perl-DBD-MySQL perl-Sys-Syslog
</code></pre></div></div>

<ul>
  <li>create the perl script in the /etc/zabbix/ directory</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$vim</span> /etc/zabbix/zabbix_partitioning.pl
</code></pre></div></div>

<ul>
  <li>Copy code below, as is into the file and edit password to match the zbx_part account you just created</li>
</ul>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/usr/bin/perl

use strict;
use Data::Dumper;
use DBI;
use Sys::Syslog qw(:standard :macros);
use DateTime;
use POSIX qw(strftime);

openlog("mysql_zbx_part", "ndelay,pid", LOG_LOCAL0);

my $db_schema = 'zabbix';
my $dsn = 'DBI:mysql:'.$db_schema.':mysql_socket=/var/lib/mysql/mysql.sock';
my $db_user_name = 'zbx_part';
my $db_password = '&lt;Zabbix partitioning DB user password&gt;';
my $tables = {  'history' =&gt; { 'period' =&gt; 'day', 'keep_history' =&gt; '30'},
        'history_log' =&gt; { 'period' =&gt; 'day', 'keep_history' =&gt; '30'},
        'history_str' =&gt; { 'period' =&gt; 'day', 'keep_history' =&gt; '30'},
        'history_text' =&gt; { 'period' =&gt; 'day', 'keep_history' =&gt; '30'},
        'history_uint' =&gt; { 'period' =&gt; 'day', 'keep_history' =&gt; '30'},
        'trends' =&gt; { 'period' =&gt; 'month', 'keep_history' =&gt; '12'},
        'trends_uint' =&gt; { 'period' =&gt; 'month', 'keep_history' =&gt; '12'},
        };
my $amount_partitions = 4;

my $curr_tz = 'Etc/UTC';

my $part_tables;

my $dbh = DBI-&gt;connect($dsn, $db_user_name, $db_password);

my $sth = $dbh-&gt;prepare(qq{SELECT table_name, partition_name, lower(partition_method) as partition_method,
                    rtrim(ltrim(partition_expression)) as partition_expression,
                    partition_description, table_rows
                FROM information_schema.partitions
                WHERE partition_name IS NOT NULL AND table_schema = ?});
$sth-&gt;execute($db_schema);

while (my $row =  $sth-&gt;fetchrow_hashref()) {
    $part_tables-&gt;{$row-&gt;{'table_name'}}-&gt;{$row-&gt;{'partition_name'}} = $row;
}

$sth-&gt;finish();

foreach my $key (sort keys %{$tables}) {
    unless (defined($part_tables-&gt;{$key})) {
        syslog(LOG_ERR, 'Partitioning for "'.$key.'" is not found! The table might be not partitioned.');
        next;
    }

    create_next_partition($key, $part_tables-&gt;{$key}, $tables-&gt;{$key}-&gt;{'period'});
    remove_old_partitions($key, $part_tables-&gt;{$key}, $tables-&gt;{$key}-&gt;{'period'}, $tables-&gt;{$key}-&gt;{'keep_history'})
}

delete_old_data();

$dbh-&gt;disconnect();

sub create_next_partition {
    my $table_name = shift;
    my $table_part = shift;
    my $period = shift;

    for (my $curr_part = 0; $curr_part &lt; $amount_partitions; $curr_part++) {
        my $next_name = name_next_part($tables-&gt;{$table_name}-&gt;{'period'}, $curr_part);
        my $found = 0;

        foreach my $partition (sort keys %{$table_part}) {
            if ($next_name eq $partition) {
                syslog(LOG_INFO, "Next partition for $table_name table has already been created. It is $next_name");
                $found = 1;
            }
        }

        if ( $found == 0 ) {
            syslog(LOG_INFO, "Creating a partition for $table_name table ($next_name)");
            my $query = 'ALTER TABLE '."$db_schema.$table_name".' ADD PARTITION (PARTITION '.$next_name.
                        ' VALUES less than (UNIX_TIMESTAMP("'.date_next_part($tables-&gt;{$table_name}-&gt;{'period'}, $curr_part).'") div 1))';
            syslog(LOG_DEBUG, $query);
            $dbh-&gt;do($query);
        }
    }
}

sub remove_old_partitions {
    my $table_name = shift;
    my $table_part = shift;
    my $period = shift;
    my $keep_history = shift;

    my $curr_date = DateTime-&gt;now;
    $curr_date-&gt;set_time_zone( $curr_tz );

    if ( $period eq 'day' ) {
        $curr_date-&gt;add(days =&gt; -$keep_history);
        $curr_date-&gt;add(hours =&gt; -$curr_date-&gt;strftime('%H'));
        $curr_date-&gt;add(minutes =&gt; -$curr_date-&gt;strftime('%M'));
        $curr_date-&gt;add(seconds =&gt; -$curr_date-&gt;strftime('%S'));
    }
    elsif ( $period eq 'week' ) {
    }
    elsif ( $period eq 'month' ) {
        $curr_date-&gt;add(months =&gt; -$keep_history);

        $curr_date-&gt;add(days =&gt; -$curr_date-&gt;strftime('%d')+1);
        $curr_date-&gt;add(hours =&gt; -$curr_date-&gt;strftime('%H'));
        $curr_date-&gt;add(minutes =&gt; -$curr_date-&gt;strftime('%M'));
        $curr_date-&gt;add(seconds =&gt; -$curr_date-&gt;strftime('%S'));
    }

    foreach my $partition (sort keys %{$table_part}) {
        if ($table_part-&gt;{$partition}-&gt;{'partition_description'} &lt;= $curr_date-&gt;epoch) {
            syslog(LOG_INFO, "Removing old $partition partition from $table_name table");

            my $query = "ALTER TABLE $db_schema.$table_name DROP PARTITION $partition";

            syslog(LOG_DEBUG, $query);
            $dbh-&gt;do($query);
        }
    }
}

sub name_next_part {
    my $period = shift;
    my $curr_part = shift;

    my $name_template;

    my $curr_date = DateTime-&gt;now;
    $curr_date-&gt;set_time_zone( $curr_tz );

    if ( $period eq 'day' ) {
        my $curr_date = $curr_date-&gt;truncate( to =&gt; 'day' );
        $curr_date-&gt;add(days =&gt; 1 + $curr_part);

        $name_template = $curr_date-&gt;strftime('p%Y_%m_%d');
    }
    elsif ($period eq 'week') {
        my $curr_date = $curr_date-&gt;truncate( to =&gt; 'week' );
        $curr_date-&gt;add(days =&gt; 7 * $curr_part);

        $name_template = $curr_date-&gt;strftime('p%Y_%m_w%W');
    }
    elsif ($period eq 'month') {
        my $curr_date = $curr_date-&gt;truncate( to =&gt; 'month' );
        $curr_date-&gt;add(months =&gt; 1 + $curr_part);

        $name_template = $curr_date-&gt;strftime('p%Y_%m');
    }

    return $name_template;
}

sub date_next_part {
    my $period = shift;
    my $curr_part = shift;

    my $period_date;

    my $curr_date = DateTime-&gt;now;
    $curr_date-&gt;set_time_zone( $curr_tz );

    if ( $period eq 'day' ) {
        my $curr_date = $curr_date-&gt;truncate( to =&gt; 'day' );
        $curr_date-&gt;add(days =&gt; 2 + $curr_part);
        $period_date = $curr_date-&gt;strftime('%Y-%m-%d');
    }
    elsif ($period eq 'week') {
        my $curr_date = $curr_date-&gt;truncate( to =&gt; 'week' );
        $curr_date-&gt;add(days =&gt; 7 * $curr_part + 1);
        $period_date = $curr_date-&gt;strftime('%Y-%m-%d');
    }
    elsif ($period eq 'month') {
        my $curr_date = $curr_date-&gt;truncate( to =&gt; 'month' );
        $curr_date-&gt;add(months =&gt; 2 + $curr_part);

        $period_date = $curr_date-&gt;strftime('%Y-%m-%d');
    }

    return $period_date;
}

sub delete_old_data {
    $dbh-&gt;do("DELETE FROM sessions WHERE lastaccess &lt; UNIX_TIMESTAMP(NOW() - INTERVAL 1 MONTH)");
    $dbh-&gt;do("TRUNCATE housekeeper");
    $dbh-&gt;do("DELETE FROM auditlog_details WHERE NOT EXISTS (SELECT NULL FROM auditlog WHERE auditlog.auditid = auditlog_details.auditid)");
}
</code></pre></div></div>

<ul>
  <li>Configure script to be run by root only (contains a database account password, so this helps protect it)</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$chmod</span> 700 /etc/zabbix/zabbix_partitioning.pl
</code></pre></div></div>

<ul>
  <li>Finally, create the cron job to run the script</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$vim</span> /etc/cron.d/zabbix-mysql-partitioning

<span class="c">#CRON FILE ENTRY:</span>

<span class="c"># Zabbix daily table partitioning</span>
<span class="nv">SHELL</span><span class="o">=</span>/bin/bash
<span class="nv">PATH</span><span class="o">=</span>/sbin:/bin:/usr/sbin:/usr/bin
<span class="nv">MAILTO</span><span class="o">=</span>root
10 7 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> root perl /etc/zabbix/zabbix_partitioning.pl 1&gt;/var/log/zabbix/zabbix_partitioning.log  2&gt;&amp;1
</code></pre></div></div>

<hr />

<h2 id="next-steps">Next Steps</h2>

<p>Now the Database is prepared.  See my <a href="/zabbixserver.html">Zabbix Application Server Installation Guide</a> for instructions on setting up the Application Server.</p>

<hr />


    <div class="tags">
        
        <b>Tags: </b>
        
        
        
        <a href="tag_getting_started.html" class="btn btn-default navbar-btn cursorNorm" role="button">getting_started</a>
        
        
        
        <a href="tag_zabbix.html" class="btn btn-default navbar-btn cursorNorm" role="button">zabbix</a>
        
        
        
        
        
    </div>



    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'steeladept'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               &copy;2018 steeladept. All rights reserved. <br />
<span>Page last updated:</span> Oct 29, 2018<br/> Site last generated: Dec 14, 2018 <br />
                </div>
            </div>
</footer>


        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>

</html>
